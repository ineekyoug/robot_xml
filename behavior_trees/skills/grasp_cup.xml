<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="GraspCup">
  <BehaviorTree ID="GraspCup">
    <Sequence>
      <TorsoAction server_name="/Torso/torso_action_service"
                   server_timeout="60000"
                   torso_height="0.13"
                   torso_yaw="0"
                   head_pitch="0"
                   head_yaw="0"
                   max_velocity="0.15"
                   work_mode="0"
                   success="{success}"
                   msg="{msg}"/>
      <Fallback>
        <ManipVisonService service_name="/manip_vision_service"
                            server_timeout="5000"
                            object_name="coffee_machine_bar"
                            action_param="0"
                            camera_id="0"
                            est_pose="{est_pose}"
                            feedback="{manip_feedback}"/>
        <RetryUntilSuccessful num_attempts="5">
          <Sequence>
            <NavAction server_name="/base_navigate"
                  server_timeout="60000"
                  action_name="turn"
                  type="0"
                  target_pose="0;0;0.174"
                  success="{success}"
                  msg="{msg}"/>
            <ManipVisonService service_name="/manip_vision_service"
                                server_timeout="5000"
                                object_name="coffee_machine_bar"
                                action_param="0"
                                camera_id="0"
                                est_pose="{est_pose}"
                                feedback="{manip_feedback}"/>
          </Sequence>
        </RetryUntilSuccessful>
        <Sequence>
          <NavAction server_name="/base_navigate"
                server_timeout="60000"
                action_name="turn"
                type="0"
                target_pose="0;0;-0.87"
                success="{success}"
                msg="{msg}"/>
          <RetryUntilSuccessful num_attempts="5">
            <Sequence>
              <NavAction server_name="/base_navigate"
                    server_timeout="60000"
                    action_name="turn"
                    type="0"
                    target_pose="0;0;-0.174"
                    success="{success}"
                    msg="{msg}"/>
              <ManipVisonService service_name="/manip_vision_service"
                                  server_timeout="5000"
                                  object_name="coffee_machine_bar"
                                  action_param="0"
                                  camera_id="0"
                                  est_pose="{est_pose}"
                                  feedback="{manip_feedback}"/>
            </Sequence>
          </RetryUntilSuccessful> 
        </Sequence>
      </Fallback>
      <TfTransformPoseService service_name="/transform_pose"
                              server_timeout="5000"
                              source_pose="{est_pose}"
                              source_frame="camera_torso_link"
                              target_frame="torso_up_link"
                              target_pose="{est_pose_up}"
                              feedback="{tf_trans_feedback}"/>
      <TfTransformPoseService service_name="/transform_pose"
                              server_timeout="5000"
                              source_pose="0.140249;-0.18001;0.455125;0.243109;0.040789;0.0102326;0.969087"
                              source_frame="camera_torso_link"
                              target_frame="torso_up_link"
                              target_pose="{desired_pose}"
                              feedback="{tf_trans_feedback}"/>
      <ChassisAdjustAction server_name="/base_navigate"
                          server_timeout="60000"
                          target_pose="{est_pose_up}"
                          desired_pose="{desired_pose}"
                          th_move_x="0.1"
                          th_move_y="100.0"
                          th_turn="0" /> 
      <ManipVisonService service_name="/manip_vision_service"
                          server_timeout="5000"
                          object_name="coffee_machine_bar"
                          action_param="0"
                          camera_id="0"
                          est_pose="{est_pose}"
                          feedback="{manip_feedback}"/>
      <TfTransformPoseService service_name="/transform_pose"
                              server_timeout="5000"
                              source_pose="{est_pose}"
                              source_frame="camera_torso_link"
                              target_frame="torso_up_link"
                              target_pose="{est_pose_up}"
                              feedback="{tf_trans_feedback}"/>
      <CustomPoseService input_pose="{est_pose_up}"
                         desired_pose="-;-;-;0.45773;0.49059;-0.53835;0.50988"
                         result_pose="{est_pose_up_o}"/>
      <PoseMulService left_pose="-0.15;-0.1;-0.05;0;0;0;1"
                      right_pose="{est_pose_up_o}"
                      result_pose="{est_pose_up_o_pre}"/>
      <Parallel failure_count="1"
                success_count="2">
        <HandAction server_name="/avaia_hand"
                    server_timeout="2000"
                    action_name="prepare_cup_right"
                    success="{hand_success}"
                    status="{hand_status}"/>
        <ArmAction server_name="/arm"
                 server_timeout="30000"
                 action_name="pre_grasp_cup"
                 action_index="1"
                 action_param="0"
                 arm_index="1"
                 goal_left="0;0;0;0;0;0;1"
                 waypoints_left=""
                 goal_right="{est_pose_up_o_pre}"
                 waypoints_right="0;-20;-20;0;0;0;0;
                                  -43.745; -28.068; -89.601; 88.097; 58.908; 12.911; 6.269;
                                  -29.560; -46.038; -116.710; 86.472; 55.027; 16.513; 1.066;
                                  -30.635; -31.917; -97.874; 112.326; 48.503; 16.695; 0.765"
                 speed_percentage="50"
                 msg="{arm_msg}"
                 pose="{arm_pose}"/>
      </Parallel>
      <PoseMulService left_pose="-0.075;-0.055;-0.10;0;0;0;1"
                      right_pose="{est_pose_up_o}"
                      result_pose="{est_pose_up_o_gra}"/>
      <ArmAction server_name="/arm"
                server_timeout="30000"
                action_name="grasp_cup"
                action_index="1"
                action_param="1"
                arm_index="1"
                goal_left="0;0;0;0;0;0;1"
                waypoints_left=""
                goal_right="{est_pose_up_o_gra}"
                waypoints_right=""
                speed_percentage="10"
                msg="{arm_msg}"
                pose="{arm_pose}"/>
      <HandAction server_name="/avaia_hand"
                  server_timeout="2000"
                  action_name="grasp_cup_right"
                  success="{hand_success}"
                  status="{hand_status}"/>
      <PoseMulService left_pose="0;0;0.01;0;0;0;1"
                      right_pose="{est_pose_up_o_gra}"
                      result_pose="{est_pose_up_o_gra_up}"/>
      <ArmAction server_name="/arm"
                 server_timeout="30000"
                 action_name="grasp_cup_up"
                 action_index="1"
                 action_param="1"
                 arm_index="1"
                 goal_left="0;0;0;0;0;0;1"
                 waypoints_left=""
                 goal_right="{est_pose_up_o_gra_up}"
                 waypoints_right=""
                 speed_percentage="10"
                 msg="{arm_msg}"
                 pose="{arm_pose}"/>
      <ArmAction server_name="/arm"
                 server_timeout="30000"
                 action_name="pre_grasp_cup"
                 action_index="1"
                 action_param="0"
                 arm_index="1"
                 goal_left="0;0;0;0;0;0;1"
                 waypoints_left=""
                 goal_right="{est_pose_up_o_pre}"
                 waypoints_right=""
                 speed_percentage="10"
                 msg="{arm_msg}"
                 pose="{arm_pose}"/>
      <ArmAction server_name="/arm"
                 server_timeout="30000"
                 action_name="grasp_cup_standby"
                 action_index="0"
                 action_param="0"
                 arm_index="1"
                 goal_left="0;0;0;0;0;0;1"
                 waypoints_left=""
                 goal_right="0;0;0;0;0;0;1"
                 waypoints_right="-10.446; -11.168; -99.714; 105.206; 81.998; 2.729; 2.557"
                 speed_percentage="10"
                 msg="{arm_msg}"
                 pose="{arm_pose}"/>
      <NavAction server_name="/base_navigate"
            server_timeout="60000"
            action_name="navigation"
            type="0"
            target_pose="-0.40142397;-1.011406010;3.14"
            success="{success}"
            msg="{msg}"/>      
      <SystemCallService command="aplay ~/waic_wmv/13.wav"/>
    </Sequence>
  </BehaviorTree>
</root>
